<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>レトロ写真加工アプリ</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Micro+5&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1720;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#d97706; /* レトロなアンバー色 */
    --safe-pad:16px;
  }
  html,body{height:100%;margin:0;}
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Noto Sans JP", sans-serif;
    background: linear-gradient(180deg,#1c1917 0%, #0f1720 100%);
    color:#0b1220;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:calc(var(--safe-pad) + 8px);
    box-sizing:border-box;
  }

  .app {
    width:100%;
    max-width:920px;
    background: #fff;
    border-radius:14px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    padding:18px;
    box-sizing:border-box;
    position: relative;
  }

  /* Loading Overlay */
  #loadingOverlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.85);
    z-index: 100;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: var(--accent);
    display: none;
  }
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid #ddd;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 10px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  h1{font-size:18px;margin:0; font-weight:800; color:#333;}
  .controls-top{
    display:flex;
    gap:10px;
    align-items:center;
  }
  #fileInput{ appearance:none; }

  .main {
    margin-top:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }

  .canvas-wrap{
    width:100%;
    background:#222;
    border-radius:10px;
    padding:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height: 200px;
    box-shadow: inset 0 0 20px #000;
  }

  canvas{
    max-width:100%;
    width:100%;
    height:auto;
    border-radius:4px;
    background:#ddd;
    touch-action: manipulation;
  }

  /* スライダーエリア */
  .slider-row{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    margin-bottom: 5px;
  }
  .slider-row label{
    font-size:14px;color:var(--muted);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .range{
    width:90%;
    max-width:540px;
    accent-color: var(--accent);
  }

  /* 日付設定エリア */
  .date-settings {
    width: 100%;
    background: #f3f4f6;
    border-radius: 10px;
    padding: 12px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 5px;
  }
  .date-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 15px;
    font-size: 14px;
  }
  .date-row label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-weight: normal !important;
  }
  .date-row input[type="date"], .date-row select {
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
    flex: 1;
    min-width: 120px;
  }
  .date-row .control-label {
    font-weight: bold;
    color: #333;
  }
  .date-options-group {
    display: flex;
    gap: 15px;
  }


  .btn-row{
    width:100%;
    margin-top:6px;
    display:flex;
    gap:10px;
    justify-content:center;
  }

  button, .file-btn{
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    font-size:15px;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
    text-align: center;
    font-weight: bold;
    transition: transform 0.1s;
  }
  button:active, .file-btn:active{ transform:scale(0.98); }
  
  button.secondary{
    background:#e6e6e6;
    color:#0b1220;
    box-shadow:none;
  }

  #filterBar{
    margin-top:12px;
    display:flex;
    gap:10px;
    overflow-x:auto;
    padding:10px;
    background:#f9f9f9;
    border-radius:10px;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #eee;
  }
  .filterItem{
    min-width:82px;
    flex:0 0 auto;
    background:#fff;
    border-radius:10px;
    border:2px solid transparent;
    padding:6px;
    box-sizing:border-box;
    text-align:center;
    font-size:12px;
    color:#444;
    cursor:pointer;
    user-select:none;
    transition: all 0.2s;
  }
  .filterItem:hover{ background:#f0f0f0; }
  .filterItem.active{
    border-color:var(--accent);
    background:#fff7ed;
    color: var(--accent);
    font-weight: bold;
    transform: translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  .thumb{
    width:64px;height:48px;border-radius:6px;background:#ddd;margin:0 auto 6px auto; display:block;
    object-fit:cover;
  }

  /* Custom Scrollbar */
  #filterBar::-webkit-scrollbar { width: 8px; height: 12px; }
  #filterBar::-webkit-scrollbar-track { background: transparent; }
  #filterBar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 30px; border: 3px solid transparent; background-clip: content-box;}
  #filterBar::-webkit-scrollbar-thumb:hover { background-color: var(--accent); }

  @media (max-width:520px){
    .btn-row{flex-direction:column;}
    .filterItem{min-width:72px;padding:6px;font-size:11px;}
    .thumb{width:56px;height:40px;}
    .date-row { flex-direction: column; align-items: stretch; }
    .date-row > * { width: 100%; box-sizing: border-box; }
    .date-options-group { flex-direction: column; gap: 10px; }
  }

  footer{margin-top:12px;font-size:11px;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="写真フィルタアプリ">
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div id="loadingText">Processing...</div>
    </div>

    <header>
      <h1>Retro Cam</h1>
      <div class="controls-top">
        <label class="file-btn" for="fileInput" title="写真を選択">＋ 写真</label>
        <input id="fileInput" type="file" accept="image/jpeg, image/png" style="display:none">
      </div>
    </header>

    <div class="main">
      <div class="canvas-wrap" aria-live="polite">
        <canvas id="canvas" width="800" height="500"></canvas>
      </div>

      <div class="slider-row" id="sliderRow" style="display:none">
        <label id="sliderLabel">エフェクト強度：<strong id="sliderValue">1.00</strong></label>
        <input id="strengthSlider" class="range" type="range" min="0" max="1" step="0.05" value="1">
      </div>

      <div class="date-settings">
        <div class="date-row">
            <label class="control-label">
                <input type="checkbox" id="dateToggle"> 日付を入れる
            </label>
            <input type="date" id="dateInput">
        </div>
        <div class="date-row" id="dateOptions" style="display:none;">
            <div class="date-options-group">
                <select id="dateFont">
                    <option value="vt323">デジタル風 (VT323)</option>
                    <option value="micro5" selected>デジタル風 (Micro 5)</option>
                </select>
                <select id="datePosition">
                    <option value="br" selected>右下 (Bottom-Right)</option>
                    <option value="bl">左下 (Bottom-Left)</option>
                    <option value="tr">右上 (Top-Right)</option>
                    <option value="tl">左上 (Top-Left)</option>
                </select>
            </div>
        </div>
      </div>

      <div class="btn-row">
        <button id="downloadBtn">画像を保存</button>
      </div>

      <div id="filterBar" aria-hidden="false"></div>
    </div>

    <footer>※ 画像は端末内で処理され、外部へ送信されません。</footer>
  </div>

<script>
/* --------- Globals & DOM ---------- */
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const filterBar = document.getElementById('filterBar');
const sliderRow = document.getElementById('sliderRow');
const strengthSlider = document.getElementById('strengthSlider');
const sliderLabel = document.getElementById('sliderLabel');
const sliderValue = document.getElementById('sliderValue');
const downloadBtn = document.getElementById('downloadBtn');

// Date Stamp DOM
const dateToggle = document.getElementById('dateToggle');
const dateOptions = document.getElementById('dateOptions');
const dateInput = document.getElementById('dateInput');
const datePosition = document.getElementById('datePosition');
const dateFont = document.getElementById('dateFont');

let originalImageData = null;
let currentFilter = 'original';
let thumbWidth = 100, thumbHeight = 64; 

/* --------- UI Helpers ---------- */
function showLoading(show){
  loadingOverlay.style.display = show ? 'flex' : 'none';
}

/* Set Today's Date */
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
dateInput.value = `${yyyy}-${mm}-${dd}`;

/* Date Toggle Logic */
dateToggle.addEventListener('change', ()=>{
    dateOptions.style.display = dateToggle.checked ? 'flex' : 'none';
    requestRender();
});
dateInput.addEventListener('change', requestRender);
datePosition.addEventListener('change', requestRender);
dateFont.addEventListener('change', requestRender);

function requestRender(){
    if(!originalImageData) return;
    showLoading(true);
    // フォントが読み込まれるのを待機
    document.fonts.ready.then(() => {
        requestAnimationFrame(async ()=>{
            await renderCurrent();
            showLoading(false);
        });
    });
}

/* --------- Filters Definition (省略) ---------- */
const filters = [
  { id:'original', name:'Original' },
  { id:'1920s', name:'1920s\nSilent' },
  { id:'1950s', name:'1950s\nVintage' },
  { id:'1970s', name:'1970s\nWarm' },
  { id:'1980s', name:'1980s\nVHS' }
];

function createFilterBar(){
  filterBar.innerHTML = '';
  filters.forEach(f=>{
    const item = document.createElement('div');
    item.className = 'filterItem';
    item.dataset.filter = f.id;

    const img = document.createElement('canvas');
    img.className = 'thumb';
    img.width = thumbWidth;
    img.height = thumbHeight;
    img.style.display = 'block';

    const label = document.createElement('div');
    label.innerText = f.name;

    item.appendChild(img);
    item.appendChild(label);
    filterBar.appendChild(item);

    item.addEventListener('click', ()=> {
      if(!originalImageData) return;
      setActiveFilter(f.id);
      requestRender();
    });
  });
}

function setActiveFilter(id){
  currentFilter = id;
  document.querySelectorAll('.filterItem').forEach(el=>{
    el.classList.toggle('active', el.dataset.filter === id);
  });

  if(id === 'original'){
    sliderRow.style.display = 'none';
  } else {
    sliderRow.style.display = 'flex';
    updateSliderLabel(strengthSlider.value);
  }
}

function updateSliderLabel(val){
    const v = Number(val).toFixed(2);
    sliderValue.textContent = v;
    let text = "強度";
    if(currentFilter === '1920s') text = "ノイズ強度";
    else if(currentFilter === '1950s') text = "色褪せ度";
    else if(currentFilter === '1970s') text = "暖色強調";
    else if(currentFilter === '1980s') text = "走査線強度";
    
    sliderLabel.innerHTML = `${text}：<strong id="sliderValue">${v}</strong>`;
}

/* --------- Image Load Logic (Same as before) ---------- */
fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  showLoading(true);
  const url = URL.createObjectURL(file);
  
  try {
    await loadImage(url);
    fileInput.value = ''; 
  } catch(err) {
    alert('画像の読み込みに失敗しました。');
    console.error(err);
  } finally {
    URL.revokeObjectURL(url);
    showLoading(false);
  }
});

function loadImage(src){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.onload = ()=>{
      const maxW = 1200;
      let w = img.naturalWidth, h = img.naturalHeight;
      if(w > maxW){
        const ratio = maxW / w;
        w = maxW; h = Math.round(h * ratio);
      }
      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      originalImageData = ctx.getImageData(0,0,canvas.width, canvas.height);
      
      updateAllThumbnails();
      setActiveFilter('1950s');
      dateToggle.checked = true;
      dateOptions.style.display = 'flex';
      
      requestRender();
      res();
    };
    img.onerror = (e) => rej(e);
    img.src = src;
  });
}

/* --------- Helper Functions (Same as before) ---------- */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function copyImageData(src){ return new ImageData(new Uint8ClampedArray(src.data), src.width, src.height); }
function applyVignette(data, width, height, strength){
  const cx = width/2;
  const cy = height/2;
  const maxDist = Math.sqrt(cx*cx + cy*cy);
  const power = 0.6 * strength; 
  for(let y=0; y<height; y++){
    for(let x=0; x<width; x++){
      const i = (y*width + x)*4;
      const dx = x - cx;
      const dy = y - cy;
      const d = Math.sqrt(dx*dx + dy*dy) / maxDist;
      const v = 1 - Math.pow(d, 2.5) * power;
      data[i]   = clamp(data[i] * v, 0, 255);
      data[i+1] = clamp(data[i+1] * v, 0, 255);
      data[i+2] = clamp(data[i+2] * v, 0, 255);
    }
  }
}

/* --------- Filter Logic (Same as before) ---------- */
function apply1920s(src, strength){
  const img = copyImageData(src);
  const d = img.data;
  const noiseAmount = 60 * strength;
  const contrast = 1.0 + (0.5 * strength);
  const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
  for(let i=0; i<d.length; i+=4){
    let r = d[i], g = d[i+1], b = d[i+2];
    let gray = 0.299*r + 0.587*g + 0.114*b;
    gray = factor * (gray - 128) + 128;
    gray += (Math.random() - 0.5) * noiseAmount;
    gray = clamp(gray, 0, 255);
    d[i] = d[i+1] = d[i+2] = gray;
  }
  return img;
}
function apply1950s(src, strength){
  const img = copyImageData(src);
  const d = img.data;
  const w = img.width, h = img.height;
  for(let i=0; i<d.length; i+=4){
    let r = d[i], g = d[i+1], b = d[i+2];
    const gray = 0.299*r + 0.587*g + 0.114*b;
    const desat = 0.4 * strength; 
    r = r*(1-desat) + gray*desat;
    g = g*(1-desat) + gray*desat;
    b = b*(1-desat) + gray*desat;
    r = r * (1 + 0.15 * strength);
    g = g * (1 + 0.05 * strength);
    b = b * (1 - 0.15 * strength);
    d[i] = clamp(r, 0, 255);
    d[i+1] = clamp(g, 0, 255);
    d[i+2] = clamp(b, 0, 255);
  }
  applyVignette(d, w, h, strength * 1.5);
  return img;
}
function apply1970s(src, strength){
  const img = copyImageData(src);
  const d = img.data;
  const noiseAmt = 30 * strength;
  for(let i=0; i<d.length; i+=4){
    let r = d[i], g = d[i+1], b = d[i+2];
    const gray = 0.299*r + 0.587*g + 0.114*b;
    const sat = 1.3 * strength; 
    if(strength > 0){
        r = gray + (r - gray) * sat;
        g = gray + (g - gray) * sat;
        b = gray + (b - gray) * sat;
    }
    r *= (1 + 0.1 * strength);
    b *= (1 - 0.1 * strength);
    const rand = (Math.random() - 0.5) * noiseAmt;
    r += rand; g += rand; b += rand;
    d[i] = clamp(r, 0, 255);
    d[i+1] = clamp(g, 0, 255);
    d[i+2] = clamp(b, 0, 255);
  }
  return img;
}
function apply1980s(src, strength){
  const img = copyImageData(src);
  const d = img.data;
  const w = img.width;
  const noiseAmt = 40 * strength;
  const scanlineInt = 4;
  for(let i=0; i<d.length; i+=4){
    let r = d[i], g = d[i+1], b = d[i+2];
    const pixelIndex = i / 4;
    const y = Math.floor(pixelIndex / w);
    r *= (1 + 0.05 * strength);
    b *= (1 + 0.1 * strength);
    if(y % scanlineInt === 0){
        const darken = 0.15 * strength; 
        r *= (1 - darken);
        g *= (1 - darken);
        b *= (1 - darken);
    }
    const rand = (Math.random() - 0.5) * noiseAmt;
    r += rand; g += rand; b += rand + (rand * 0.5);
    d[i] = clamp(r, 0, 255);
    d[i+1] = clamp(g, 0, 255);
    d[i+2] = clamp(b, 0, 255);
  }
  return img;
}


/* --------- Render logic ---------- */
async function renderCurrent(){
  if(!originalImageData) return;
  const strength = parseFloat(strengthSlider.value);
  updateSliderLabel(strength);
  
  return new Promise(resolve => {
    setTimeout(() => {
        let out = originalImageData;
        
        // 1. Apply Filter
        if(currentFilter === '1920s'){
            out = apply1920s(originalImageData, strength);
        } else if(currentFilter === '1950s'){
            out = apply1950s(originalImageData, strength);
        } else if(currentFilter === '1970s'){
            out = apply1970s(originalImageData, strength);
        } else if(currentFilter === '1980s'){
            out = apply1980s(originalImageData, strength);
        }
        
        ctx.putImageData(out, 0, 0);

        // 2. Apply Date Stamp (If enabled)
        if(dateToggle.checked){
            drawDateStamp();
        }

        resolve();
    }, 0);
  });
}

function drawDateStamp(){
    const dateVal = dateInput.value;
    if(!dateVal) return;
    
    const text = dateVal.replace(/-/g, '.');

    const w = canvas.width;
    const h = canvas.height;
    
    // フォントの選択
    const selectedFont = dateFont.value;
    let fontFamily = '';
    if (selectedFont === 'vt323') {
        fontFamily = "'VT323', monospace"; // 現行のデジタル風
    } else if (selectedFont === 'micro5') {
        // Micro 5フォントを指定
        fontFamily = "'Micro 5', monospace"; 
    }
    
    // サイズと余白
    const fontSize = Math.max(16, Math.floor(h * 0.05)); 
    const paddingX = Math.floor(w * 0.04);
    const paddingY = Math.floor(h * 0.04);

    ctx.save();
    
    // Micro 5フォントは非常に小さいため、通常よりもサイズを大きくする必要がある場合があります
    let effectiveFontSize = fontSize;
    if (selectedFont === 'micro5') {
        // Micro 5は通常のフォントより小さく表示されるため、補正する
        effectiveFontSize = fontSize * 1.5; 
    }

    ctx.font = `${effectiveFontSize}px ${fontFamily}`;
    ctx.textBaseline = 'bottom';
    
    const color = '#ff9900'; 
    ctx.fillStyle = color;
    
    ctx.shadowColor = '#ff5500';
    ctx.shadowBlur = fontSize * 0.4;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    // Positioning
    const pos = datePosition.value;
    let x, y;

    if(pos === 'br'){ 
        ctx.textAlign = 'right';
        x = w - paddingX;
        y = h - paddingY;
    } else if(pos === 'bl'){ 
        ctx.textAlign = 'left';
        x = paddingX;
        y = h - paddingY;
    } else if(pos === 'tr'){ 
        ctx.textAlign = 'right';
        ctx.textBaseline = 'top';
        x = w - paddingX;
        y = paddingY;
    } else if(pos === 'tl'){ 
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        x = paddingX;
        y = paddingY;
    }

    ctx.globalAlpha = 0.85;
    ctx.fillText(text, x, y);

    ctx.restore();
}

/* Debounce for slider */
let renderTimeout;
strengthSlider.addEventListener('input', ()=>{
  updateSliderLabel(strengthSlider.value);
  clearTimeout(renderTimeout);
  renderTimeout = setTimeout(()=>{
      requestRender();
  }, 100);
});

downloadBtn.addEventListener('click', ()=>{
  if(!originalImageData) return alert('画像を選択してください');
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/jpeg', 0.85);
  a.download = `retro_${currentFilter}_edited.jpg`; 
  a.click();
});

/* Create thumbnails with current filters */
function updateAllThumbnails(){
  const iw = originalImageData.width, ih = originalImageData.height;
  const tmp = document.createElement('canvas');
  tmp.width = iw; tmp.height = ih;
  tmp.getContext('2d').putImageData(originalImageData,0,0);
  
  const smallC = document.createElement('canvas');
  smallC.width = thumbWidth; smallC.height = thumbHeight;
  const sCtx = smallC.getContext('2d');
  sCtx.drawImage(tmp, 0, 0, iw, ih, 0, 0, thumbWidth, thumbHeight);
  const smallData = sCtx.getImageData(0,0,thumbWidth,thumbHeight);

  document.querySelectorAll('.filterItem').forEach((el)=>{
    const canvasThumb = el.querySelector('canvas');
    if(!canvasThumb) return;
    const ctxT = canvasThumb.getContext('2d');
    const fId = el.dataset.filter;
    
    let out = smallData;
    if(fId === '1920s') out = apply1920s(smallData, 1.0);
    else if(fId === '1950s') out = apply1950s(smallData, 1.0);
    else if(fId === '1970s') out = apply1970s(smallData, 1.0);
    else if(fId === '1980s') out = apply1980s(smallData, 1.0);
    
    ctxT.putImageData(out,0,0);
  });
}

/* Init */
createFilterBar();
setActiveFilter('original');
drawPlaceholder();

/* Drag & Drop */
canvas.addEventListener('dragover', (e)=>{ e.preventDefault(); });
canvas.addEventListener('drop', (e)=>{
  e.preventDefault();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f){
    showLoading(true);
    const url = URL.createObjectURL(f);
    loadImage(url).then(()=>{ 
        URL.revokeObjectURL(url);
        showLoading(false);
    });
  }
});

function drawPlaceholder(){
  ctx.clearRect(0,0,canvas.width, canvas.height);
  const w = canvas.width = Math.min(800, window.innerWidth - 32);
  const h = canvas.height = Math.round(w * 0.62);
  ctx.fillStyle = '#2a2a2a';
  ctx.fillRect(0,0,w,h);
  ctx.fillStyle = '#666';
  ctx.font = 'bold 14px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('写真をここにドロップ', w/2, h/2);
}
</script>
</body>
</html>
