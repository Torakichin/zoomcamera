<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Retro Cam</title>
<link rel="icon" href="icon.ico" sizes="any">
<link rel="apple-touch-icon" href="icon.ico" sizes="180x180">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Micro+5&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0f1720;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#d97706;
    --safe-pad:16px;
  }
  html,body{height:100%;margin:0;}
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Noto Sans JP", sans-serif;
    background: linear-gradient(180deg,#1c1917 0%, #0f1720 100%);
    color:#0b1220;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:calc(var(--safe-pad) + 8px);
    box-sizing:border-box;
  }

  .app {
    width:100%;
    max-width:920px;
    background: #fff;
    border-radius:14px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    padding:18px;
    box-sizing:border-box;
    position: relative;
    overflow: hidden;
  }

  #loadingOverlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.85);
    z-index: 100;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: var(--accent);
    display: none;
  }
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid #ddd;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 10px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  h1{font-size:18px;margin:0; font-weight:800; color:#333;}
  .controls-top{
    display:flex;
    gap:10px;
    align-items:center;
  }
  #fileInput{ appearance:none; }

  .main {
    margin-top:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }

  .canvas-wrap{
    width:100%;
    background:#222;
    border-radius:10px;
    padding:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height: 200px;
    box-shadow: inset 0 0 20px #000;
    box-sizing: border-box;
  }

  canvas{
    max-width:100%;
    width:100%;
    height:auto;
    border-radius:4px;
    background:#ddd;
    touch-action: manipulation;
  }

  .slider-row{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    margin-bottom: 5px;
  }
  .slider-row label{
    font-size:14px;color:var(--muted);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .range{
    width:90%;
    max-width:540px;
    accent-color: var(--accent);
  }
  
  #filterBar{
    margin-top:12px;
    display:flex;
    gap:10px;
    overflow-x:auto;
    padding:10px;
    background:#f9f9f9;
    border-radius:10px;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #eee;
  }
  .filterItem{
    min-width:82px;
    flex:0 0 auto;
    background:#fff;
    border-radius:10px;
    border:2px solid transparent;
    padding:6px;
    box-sizing:border-box;
    text-align:center;
    font-size:12px;
    color:#444;
    cursor:pointer;
    user-select:none;
    transition: all 0.2s;
  }
  .filterItem:hover{ background:#f0f0f0; }
  .filterItem.active{
    border-color:var(--accent);
    background:#fff7ed;
    color: var(--accent);
    font-weight: bold;
    transform: translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  .thumb{
    width:64px;height:48px;border-radius:6px;background:#ddd;margin:0 auto 6px auto; display:block;
    object-fit:cover;
  }

  .date-settings {
    width: 100%;
    background: #f3f4f6;
    border-radius: 10px;
    padding: 12px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
  }
  .date-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 15px;
    font-size: 14px;
  }
  .date-row label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-weight: normal !important;
  }
  .date-row input[type="date"], .date-row select {
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
    flex: 1;
    min-width: 120px;
  }
  .date-row .control-label {
    font-weight: bold;
    color: #333;
  }

  .btn-row{
    width:100%;
    margin-top:10px;
    display:flex;
    gap:10px;
    justify-content:center;
  }

  button, .file-btn{
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    font-size:15px;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
    text-align: center;
    font-weight: bold;
    transition: transform 0.1s;
  }
  
  #filterBar::-webkit-scrollbar { width: 8px; height: 12px; }
  #filterBar::-webkit-scrollbar-track { background: transparent; }
  #filterBar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 30px; border: 3px solid transparent; background-clip: content-box;}

  @media (max-width:520px){
    body { padding: 0; background: #fff; }
    .app { max-width: 100%; border-radius: 0; box-shadow: none; padding: 0; }
    header { padding: 16px 16px 0 16px; }
    .main { margin-top: 10px; gap: 16px; }
    .canvas-wrap { border-radius: 0; padding: 0; }
    canvas { border-radius: 0; }
    .slider-row, #filterBar, .date-settings, .btn-row, footer {
      padding-left: 16px; padding-right: 16px; width: 100%; box-sizing: border-box;
    }
    .date-settings { width: calc(100% - 32px); margin-left: 16px; }
    .btn-row { flex-direction: column; }
    footer { padding-bottom: 24px; }
  }

  footer{margin-top:12px;font-size:11px;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <div class="app">
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div id="loadingText">Processing...</div>
    </div>

    <header>
      <h1>Retro Cam</h1>
      <div class="controls-top">
        <label class="file-btn" for="fileInput">＋ 写真</label>
        <input id="fileInput" type="file" accept="image/jpeg, image/png" style="display:none">
      </div>
    </header>

    <div class="main">
      <div class="canvas-wrap">
        <canvas id="canvas" width="800" height="500"></canvas>
      </div>

      <div class="slider-row" id="sliderRow" style="display:none">
        <label id="sliderLabel">エフェクト強度：<strong id="sliderValue">1.00</strong></label>
        <input id="strengthSlider" class="range" type="range" min="0" max="1" step="0.05" value="1">
      </div>
      
      <div id="filterBar"></div>

      <div class="date-settings">
        <div class="date-row">
            <label class="control-label">
                <input type="checkbox" id="dateToggle"> 日付を入れる
            </label>
            <input type="date" id="dateInput">
        </div>
        <div class="date-row" id="dateOptions" style="display:none;">
            <select id="dateFont">
                <option value="vt323" selected>デジタル風 (VT323)</option>
                <option value="micro5">デジタル風 (Micro 5)</option>
            </select>
            <select id="datePosition">
                <option value="br" selected>右下</option>
                <option value="bl">左下</option>
                <option value="tr">右上</option>
                <option value="tl">左上</option>
            </select>
        </div>
      </div>

      <div class="btn-row">
        <button id="downloadBtn">画像を保存</button>
      </div>
    </div>
    <footer>※ 画像は端末内で処理され、外部へ送信されません。</footer>
  </div>

<script>
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const filterBar = document.getElementById('filterBar');
const sliderRow = document.getElementById('sliderRow');
const strengthSlider = document.getElementById('strengthSlider');
const sliderLabel = document.getElementById('sliderLabel');
const sliderValue = document.getElementById('sliderValue');
const downloadBtn = document.getElementById('downloadBtn');
const dateToggle = document.getElementById('dateToggle');
const dateOptions = document.getElementById('dateOptions');
const dateInput = document.getElementById('dateInput');
const datePosition = document.getElementById('datePosition');
const dateFont = document.getElementById('dateFont');

let originalImageData = null;
let currentFilter = 'original';
let thumbWidth = 100, thumbHeight = 64; 

function showLoading(show){
  document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

const today = new Date();
dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

dateToggle.addEventListener('change', ()=>{
    dateOptions.style.display = dateToggle.checked ? 'flex' : 'none';
    requestRender();
});
[dateInput, datePosition, dateFont].forEach(el => el.addEventListener('change', requestRender));

function requestRender(){
    if(!originalImageData) return;
    showLoading(true);
    document.fonts.ready.then(() => {
        requestAnimationFrame(async ()=>{
            await renderCurrent();
            showLoading(false);
        });
    });
}

const filters = [
  { id:'original', name:'Original' },
  { id:'1920s', name:'1920s\nSilent' },
  { id:'1950s', name:'1950s\nVintage' },
  { id:'1970s', name:'1970s\nWarm' },
  { id:'1980s', name:'1980s\nVHS' },
  { id:'classic', name:'Classic\nFilm' } // フィルタ名を変更
];

function createFilterBar(){
  filterBar.innerHTML = '';
  filters.forEach(f=>{
    const item = document.createElement('div');
    item.className = 'filterItem';
    item.dataset.filter = f.id;
    const img = document.createElement('canvas');
    img.className = 'thumb';
    img.width = thumbWidth; img.height = thumbHeight;
    const label = document.createElement('div');
    label.innerText = f.name;
    item.appendChild(img); item.appendChild(label);
    filterBar.appendChild(item);
    item.addEventListener('click', ()=> {
      if(!originalImageData) return;
      setActiveFilter(f.id);
      requestRender();
    });
  });
}

function setActiveFilter(id){
  currentFilter = id;
  document.querySelectorAll('.filterItem').forEach(el=>{
    el.classList.toggle('active', el.dataset.filter === id);
  });

  if(id === 'original'){
    sliderRow.style.display = 'none';
  } else {
    sliderRow.style.display = 'flex';
    strengthSlider.max = "1.00";
    strengthSlider.step = "0.05";
    updateSliderLabel(strengthSlider.value);
  }
}

function updateSliderLabel(val){
    const v = Number(val).toFixed(2);
    sliderValue.textContent = v;
    let text = "強度";
    if(currentFilter === '1920s') text = "ノイズ強度";
    else if(currentFilter === '1950s') text = "色褪せ度";
    else if(currentFilter === '1970s') text = "暖色強調";
    else if(currentFilter === '1980s') text = "走査線強度";
    else if(currentFilter === 'classic') text = "レトロ強度"; // ラベル変更
    sliderLabel.innerHTML = `${text}：<strong id="sliderValue">${v}</strong>`;
}

fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  showLoading(true);
  const url = URL.createObjectURL(file);
  try {
    await loadImage(url);
    fileInput.value = ''; 
  } catch(err) {
    alert('画像の読み込みに失敗しました。');
  } finally {
    URL.revokeObjectURL(url);
    showLoading(false);
  }
});

function loadImage(src){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.onload = ()=>{
      const maxW = 1200;
      let w = img.naturalWidth, h = img.naturalHeight;
      if(w > maxW){
        const ratio = maxW / w;
        w = maxW; h = Math.round(h * ratio);
      }
      canvas.width = w; canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      originalImageData = ctx.getImageData(0,0,w,h);
      updateAllThumbnails();
      setActiveFilter('1950s');
      dateToggle.checked = true;
      dateOptions.style.display = 'flex';
      requestRender();
      res();
    };
    img.src = src;
  });
}

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function copyImageData(src){ return new ImageData(new Uint8ClampedArray(src.data), src.width, src.height); }

function applyVignette(data, width, height, strength){
  const cx = width/2;
  const cy = height/2;
  const maxDist = Math.sqrt(cx*cx + cy*cy);
  const power = 0.6 * strength; 
  for(let y=0; y<height; y++){
    for(let x=0; x<width; x++){
      const i = (y*width + x)*4;
      const dx = x - cx;
      const dy = y - cy;
      const d = Math.sqrt(dx*dx + dy*dy) / maxDist;
      const v = 1 - Math.pow(d, 2.5) * power;
      data[i]   = clamp(data[i] * v, 0, 255);
      data[i+1] = clamp(data[i+1] * v, 0, 255);
      data[i+2] = clamp(data[i+2] * v, 0, 255);
    }
  }
}

/* 各フィルタロジック */
function apply1920s(src, strength){
  const img = copyImageData(src); const d = img.data;
  const noiseAmount = 60 * strength;
  const factor = (259 * ( (1.0 + 0.5 * strength) + 255)) / (255 * (259 - (1.0 + 0.5 * strength)));
  for(let i=0; i<d.length; i+=4){
    let gray = factor * ((0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2]) - 128) + 128;
    gray += (Math.random() - 0.5) * noiseAmount;
    d[i] = d[i+1] = d[i+2] = clamp(gray, 0, 255);
  }
  return img;
}

function apply1950s(src, strength){
  const img = copyImageData(src); const d = img.data; const w = img.width, h = img.height;
  for(let i=0; i<d.length; i+=4){
    const gray = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    const desat = 0.4 * strength; 
    d[i] = clamp(d[i]*(1-desat) + gray*desat * (1 + 0.15 * strength), 0, 255);
    d[i+1] = clamp(d[i+1]*(1-desat) + gray*desat * (1 + 0.05 * strength), 0, 255);
    d[i+2] = clamp(d[i+2]*(1-desat) + gray*desat * (1 - 0.15 * strength), 0, 255);
  }
  applyVignette(d, w, h, strength * 1.5);
  return img;
}

function apply1970s(src, strength){
  const img = copyImageData(src); const d = img.data;
  for(let i=0; i<d.length; i+=4){
    const gray = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    d[i] = clamp((gray + (d[i] - gray) * (1.3 * strength)) * (1 + 0.1 * strength), 0, 255);
    d[i+1] = clamp(gray + (d[i+1] - gray) * (1.3 * strength), 0, 255);
    d[i+2] = clamp((gray + (d[i+2] - gray) * (1.3 * strength)) * (1 - 0.1 * strength), 0, 255);
  }
  return img;
}

function apply1980s(src, strength){
  const img = copyImageData(src); const d = img.data; const w = img.width;
  for(let i=0; i<d.length; i+=4){
    const y = Math.floor((i/4) / w);
    if(y % 4 === 0) { d[i]*=(1-0.15*strength); d[i+1]*=(1-0.15*strength); d[i+2]*=(1-0.15*strength); }
    const r = (Math.random()-0.5)*(40*strength);
    d[i]=clamp(d[i]+r,0,255); d[i+1]=clamp(d[i+1]+r,0,255); d[i+2]=clamp(d[i+2]+r,0,255);
  }
  return img;
}

/* 新しい Classic Film フィルタ (ロジックを全面修正) */
function applyClassicFilm(src, strength) {
  const img = copyImageData(src);
  const d = img.data;
  // ノイズ量は少し控えめに
  const noiseAmt = 30 * strength;

  for(let i=0; i<d.length; i+=4){
    let r = d[i], g = d[i+1], b = d[i+2];

    // 1. 彩度を少し下げる (Desaturation)
    const gray = 0.299*r + 0.587*g + 0.114*b;
    const desatStrength = 0.3 * strength; // 30%程度彩度を落とす
    r = r * (1 - desatStrength) + gray * desatStrength;
    g = g * (1 - desatStrength) + gray * desatStrength;
    b = b * (1 - desatStrength) + gray * desatStrength;

    // 2. 色調補正 (温かみのあるセピア調へ)
    // 赤を少し強く、青を少し弱くして、黄色/オレンジ寄りにする
    r *= (1 + 0.15 * strength);
    g *= (1 + 0.05 * strength);
    b *= (1 - 0.15 * strength);

    // 3. フィルム粒子ノイズを追加
    const rand = (Math.random() - 0.5) * noiseAmt;
    r += rand; g += rand; b += rand;

    d[i] = clamp(r, 0, 255);
    d[i+1] = clamp(g, 0, 255);
    d[i+2] = clamp(b, 0, 255);
  }
  // ヴィネット効果は削除
  return img;
}

async function renderCurrent(){
  if(!originalImageData) return;
  const strength = parseFloat(strengthSlider.value);
  updateSliderLabel(strength);
  return new Promise(resolve => {
    setTimeout(() => {
        let out = originalImageData;
        if(currentFilter === '1920s') out = apply1920s(originalImageData, strength);
        else if(currentFilter === '1950s') out = apply1950s(originalImageData, strength);
        else if(currentFilter === '1970s') out = apply1970s(originalImageData, strength);
        else if(currentFilter === '1980s') out = apply1980s(originalImageData, strength);
        else if(currentFilter === 'classic') out = applyClassicFilm(originalImageData, strength); // 新フィルタ適用
        ctx.putImageData(out, 0, 0);
        if(dateToggle.checked) drawDateStamp();
        resolve();
    }, 0);
  });
}

function drawDateStamp(){
    const text = dateInput.value.replace(/-/g, '.');
    const w = canvas.width, h = canvas.height;
    const stableFontSize = clamp(Math.floor(h * 0.04), 18, 40); 
    let effSize = (dateFont.value === 'micro5') ? stableFontSize * 1.5 : stableFontSize;
    ctx.save();
    ctx.font = `${effSize}px ${(dateFont.value === 'vt323') ? "'VT323', monospace" : "'Micro 5', monospace"}`;
    ctx.fillStyle = '#ff9900';
    ctx.shadowColor = '#ff5500'; ctx.shadowBlur = stableFontSize * 0.4;
    const pos = datePosition.value;
    ctx.textAlign = (pos.includes('r')) ? 'right' : 'left';
    ctx.textBaseline = (pos.includes('t')) ? 'top' : 'bottom';
    ctx.globalAlpha = 0.85;
    ctx.fillText(text, (pos.includes('r')) ? w * 0.96 : w * 0.04, (pos.includes('t')) ? h * 0.04 : h * 0.96);
    ctx.restore();
}

let renderTimeout;
strengthSlider.addEventListener('input', ()=>{
  updateSliderLabel(strengthSlider.value);
  clearTimeout(renderTimeout);
  renderTimeout = setTimeout(requestRender, 100);
});

downloadBtn.addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/jpeg', 0.85);
  a.download = `retro_${currentFilter}.jpg`; a.click();
});

function updateAllThumbnails(){
  const iw = originalImageData.width, ih = originalImageData.height;
  const tmp = document.createElement('canvas'); tmp.width = iw; tmp.height = ih;
  tmp.getContext('2d').putImageData(originalImageData,0,0);
  const smallC = document.createElement('canvas'); smallC.width = thumbWidth; smallC.height = thumbHeight;
  const sCtx = smallC.getContext('2d');
  sCtx.drawImage(tmp, 0, 0, iw, ih, 0, 0, thumbWidth, thumbHeight);
  const smallData = sCtx.getImageData(0,0,thumbWidth,thumbHeight);
  document.querySelectorAll('.filterItem').forEach((el)=>{
    const ctxT = el.querySelector('canvas').getContext('2d');
    const fId = el.dataset.filter;
    let out = smallData;
    if(fId === '1920s') out = apply1920s(smallData, 1.0);
    else if(fId === '1950s') out = apply1950s(smallData, 1.0);
    else if(fId === '1970s') out = apply1970s(smallData, 1.0);
    else if(fId === '1980s') out = apply1980s(smallData, 1.0);
    else if(fId === 'classic') out = applyClassicFilm(smallData, 1.0); // サムネイルにも適用
    ctxT.putImageData(out,0,0);
  });
}

createFilterBar(); setActiveFilter('original');
ctx.fillStyle = '#2a2a2a'; ctx.fillRect(0,0,800,500);
</script>
</body>
</html>
