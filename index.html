<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ºãƒ¼ãƒ ã‚«ãƒ¡ãƒ© (Canvas)</title>
<style>
  :root{--w:360px;--h:480px}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN",Meiryo,sans-serif;
       margin:18px; color:#111; display:flex; flex-direction:column; align-items:center; gap:12px}
  h1{font-size:18px;margin:0}
  #stage{width:var(--w); height:var(--h); background:#000; border-radius:8px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.18)}
  canvas#preview{width:100%; height:100%; display:block}
  .controls{width:var(--w); display:flex; flex-direction:column; gap:8px}
  .row{display:flex; align-items:center; gap:8px}
  input[type=range]{flex:1}
  button{padding:8px 14px; border-radius:8px; border:0; background:#0b7cff; color:white; font-weight:600; cursor:pointer}
  #photo{width:var(--w); border-radius:6px; border:1px solid #ccc}
  small{color:#666}
  /* responsive */
  @media (max-width:420px){
    :root{--w:320px;--h:426px}
  }
</style>
</head>
<body>
  <h1>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ºãƒ¼ãƒ ã‚«ãƒ¡ãƒ©</h1>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ Canvas -->
  <div id="stage">
    <canvas id="preview"></canvas>
  </div>

  <div class="controls">
    <div class="row">
      <label style="width:72px">ã‚ºãƒ¼ãƒ </label>
      <input id="zoomRange" type="range" min="1" max="20" step="0.1" value="1">
      <div style="width:60px;text-align:right"><span id="zoomLabel">1.0x</span></div>
    </div>
    <div class="row" style="justify-content:space-between">
      <button id="captureBtn">ğŸ“¸ æ’®å½±</button>
      <div style="display:flex;align-items:center;gap:8px">
        <small id="fpsText">-- fps</small>
        <small id="resText">è§£åƒåº¦: --</small>
      </div>
    </div>
  </div>

  <h3>æ’®å½±çµæœ</h3>
  <img id="photo" alt="capture result">

  <!-- hidden video (source) & offscreen canvas for capture -->
  <video id="video" autoplay playsinline muted style="display:none"></video>
  <canvas id="captureCanvas" style="display:none"></canvas>

<script>
(async ()=>{

  // è¦ç´ 
  const video = document.getElementById('video');
  const preview = document.getElementById('preview');
  const previewCtx = preview.getContext('2d');
  const captureCanvas = document.getElementById('captureCanvas');
  const photoEl = document.getElementById('photo');
  const zoomRange = document.getElementById('zoomRange');
  const zoomLabel = document.getElementById('zoomLabel');
  const captureBtn = document.getElementById('captureBtn');
  const fpsText = document.getElementById('fpsText');
  const resText = document.getElementById('resText');

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆCSSã§æŒ‡å®šã®ãƒ”ã‚¯ã‚»ãƒ«ã«åˆã‚ã›ã‚‹ï¼‰
  // canvas.width/heightã¯å†…éƒ¨ãƒ”ã‚¯ã‚»ãƒ«æ•°ï¼ˆå‡ºåŠ›å“è³ªã«å½±éŸ¿ï¼‰
  const displayW = preview.clientWidth;
  const displayH = preview.clientHeight;
  preview.width = displayW;
  preview.height = displayH;

  // ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆé«˜è§£åƒåº¦ã‚’è¦æ±‚ï¼‰
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
        width: { ideal: 3840 },    // é«˜è§£åƒåº¦ã‚’è¦æ±‚ï¼ˆãƒ‡ãƒã‚¤ã‚¹ä¾å­˜ï¼‰
        height: { ideal: 2160 }
      },
      audio: false
    });
  } catch (e) {
    alert('ã‚«ãƒ¡ãƒ©ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ' + e.message);
    console.error(e);
    return;
  }
  video.srcObject = stream;
  const track = stream.getVideoTracks()[0];

  // video ãŒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã¾ã§å¾…ã¤
  await new Promise(r => video.onloadedmetadata = r);

  // å®Ÿã‚»ãƒ³ã‚µãƒ¼è§£åƒåº¦ï¼ˆåˆ©ç”¨å¯èƒ½ãªã‚‰ï¼‰
  const settings = track.getSettings();
  const realW = settings.width || video.videoWidth;
  const realH = settings.height || video.videoHeight;
  resText.textContent = `è§£åƒåº¦: ${realW}Ã—${realH}`;

  // çŠ¶æ…‹
  let zoom = parseFloat(zoomRange.value);

  zoomRange.addEventListener('input', () => {
    zoom = parseFloat(zoomRange.value);
    zoomLabel.textContent = zoom.toFixed(1) + 'x';
  });

  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¶å¾¡ï¼ˆfpsåˆ¶é™ï¼‰ - é«˜è² è·å¯¾ç­–
  const targetFps = 30; // ç›®æ¨™FPSï¼ˆå¿…è¦ãªã‚‰ä¸‹ã’ã‚‹ï¼‰
  const frameInterval = 1000 / targetFps;
  let lastFrameTime = performance.now();

  // FPSè¨ˆæ¸¬
  let lastFpsTime = performance.now();
  let frames = 0;

  // ç”»è³ªã®ãƒ’ãƒ³ãƒˆ
  previewCtx.imageSmoothingEnabled = true;
  previewCtx.imageSmoothingQuality = 'high';

  // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ï¼ˆvideo -> preview canvasã€ä¸­å¤®ã‚¯ãƒ­ãƒƒãƒ—ã—ã¦æ‹¡å¤§ï¼‰
  function renderLoop(now){
    requestAnimationFrame(renderLoop);

    if(now - lastFrameTime < frameInterval) return; // fpsåˆ¶é™
    lastFrameTime = now;

    // è¨ˆæ¸¬
    frames++;
    if(now - lastFpsTime > 500){
      const fps = Math.round(frames * 1000 / (now - lastFpsTime));
      fpsText.textContent = `${fps} fps`;
      frames = 0;
      lastFpsTime = now;
    }

    // å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ä¸­å¿ƒã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã‚’æ±ºã‚ã‚‹ï¼ˆã‚»ãƒ³ã‚µãƒ¼è§£åƒåº¦ã«åŸºã¥ãï¼‰
    // ãŸã ã— video.videoWidth/Height ã¯ãƒ‡ã‚³ãƒ¼ãƒ€ã®è§£åƒåº¦ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‚‹
    const srcW = realW / zoom;
    const srcH = realH / zoom;
    const srcX = Math.max(0, (realW - srcW) / 2);
    const srcY = Math.max(0, (realH - srcH) / 2);

    // drawImage ã¯ video ã®ãƒ”ã‚¯ã‚»ãƒ«è§£åƒåº¦ã‚’ä½¿ã†ã€‚deviceã«ã‚ˆã£ã¦ã¯ video.videoWidth ãŒå®Ÿå€¤ã®å ´åˆã‚‚ã‚ã‚‹ã€‚
    // ã“ã“ã§ã¯ video.videoWidth/video.videoHeight ã‚’ç”¨ã„ã‚‹ã»ã†ãŒäº’æ›æ€§é«˜ã„
    const vidW = video.videoWidth || realW;
    const vidH = video.videoHeight || realH;
    // src ã‚’å‹•ç”»ã®ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆã‚ã›ã‚‹ï¼ˆæ¯”ä¾‹å¤‰æ›ï¼‰
    const scaleW = vidW / realW;
    const scaleH = vidH / realH;
    const vSrcX = srcX * scaleW;
    const vSrcY = srcY * scaleH;
    const vSrcW = srcW * scaleW;
    const vSrcH = srcH * scaleH;

    // æœ€çµ‚çš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼canvasã«æç”»ï¼ˆæ‹¡å¤§ï¼‰
    previewCtx.clearRect(0,0,preview.width,preview.height);
    try{
      previewCtx.drawImage(video, vSrcX, vSrcY, vSrcW, vSrcH, 0, 0, preview.width, preview.height);
    }catch(e){
      // ãƒ–ãƒ©ã‚¦ã‚¶/ãƒ‡ãƒã‚¤ã‚¹ã«ã‚ˆã£ã¦ã¯ä¸€æ™‚çš„ã«å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹
      // console.warn(e);
    }
  }

  requestAnimationFrame(renderLoop);

  // æ’®å½±å‡¦ç†
  captureBtn.addEventListener('click', () => {
    // å‡ºåŠ›è§£åƒåº¦ï¼ˆã§ãã‚Œã°é«˜è§£åƒåº¦ã§ä¿å­˜ã—ãŸã„ï¼‰
    // captureCanvas ã«å®Ÿã‚»ãƒ³ã‚µãƒ¼ç›¸å½“ã®ã‚¯ãƒ­ãƒƒãƒ—ã‚’æãã€ç¸®å°ã—ã¦ä¿å­˜ã™ã‚‹
    const outW = Math.min(2048, realW); // å‡ºåŠ›ã‚’å¤§ãã‚ã«ã€‚å¿…è¦ãªã‚‰æ›´ã«ä¸Šã’ã¦ä¸‹ã•ã„ã€‚
    const outH = Math.round(outW * (preview.height / preview.width));

    // crop in sensor coords
    const cropW = realW / zoom;
    const cropH = realH / zoom;
    const cropX = Math.max(0, Math.floor((realW - cropW) / 2));
    const cropY = Math.max(0, Math.floor((realH - cropH) / 2));

    captureCanvas.width = outW;
    captureCanvas.height = outH;
    const cctx = captureCanvas.getContext('2d');
    cctx.imageSmoothingEnabled = true;
    cctx.imageSmoothingQuality = 'high';

    // video.videoWidth/video.videoHeight ã¨ realW/realH ãŒä¸€è‡´ã—ãªã„ãƒ‡ãƒã‚¤ã‚¹ãŒã‚ã‚‹ãŸã‚ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
    const vW = video.videoWidth || realW;
    const vH = video.videoHeight || realH;
    const scaleX = vW / realW;
    const scaleY = vH / realH;

    const vCropX = cropX * scaleX;
    const vCropY = cropY * scaleY;
    const vCropW = cropW * scaleX;
    const vCropH = cropH * scaleY;

    // drawImage(video, sx,sy,sw,sh, dx,dy,dw,dh)
    cctx.drawImage(video, vCropX, vCropY, vCropW, vCropH, 0, 0, outW, outH);

    // ç”»åƒã¨ã—ã¦è¡¨ç¤º and ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ãƒªãƒ³ã‚¯ç”Ÿæˆ
    const dataUrl = captureCanvas.toDataURL('image/jpeg', 0.92);
    photoEl.src = dataUrl;

    // è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå¿…è¦ãªã‘ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = `capture_z${zoom.toFixed(1)}x.jpg`;
    a.click();
  });

  // çµ‚äº†å‡¦ç†ï¼ˆãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨ãã«ã‚«ãƒ¡ãƒ©åœæ­¢ï¼‰
  window.addEventListener('beforeunload', ()=> {
    try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
  });

})();
</script>
</body>
</html>
