<!DOCTYPE html>
<html>
<body>
<style>
  #preview {
    width: 100%;
    transform: scale(1); 
    transform-origin: center center;
  }
  #captureCanvas {
    display: none; /* ← 通常は非表示 */
  }
</style>

<video id="preview" autoplay playsinline muted></video>
<button onclick="takePhoto()">撮影</button>
<input id="zoom" type="range" min="1" max="20" value="1" step="0.1">

<canvas id="captureCanvas"></canvas>

<script>
let stream;
let video = document.getElementById("preview");
let zoomBar = document.getElementById("zoom");

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false
        });

        video.srcObject = stream;

        // Safari対策：video が再生開始された後にズームを適用
        video.onloadedmetadata = () => {
            video.play();
            applyZoom();
        };

    } catch (e) {
        alert("カメラエラー: " + e.name);
    }
}

function applyZoom() {
    const z = zoomBar.value;
    video.style.transform = `scale(${z})`;
}

zoomBar.oninput = applyZoom;

function takePhoto() {
    const canvas = document.getElementById("captureCanvas");
    const ctx = canvas.getContext("2d");

    // canvasサイズを video に合わせる
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // 現在のズームを反映して切り取る
    const zoom = zoomBar.value;
    const w = canvas.width / zoom;
    const h = canvas.height / zoom;
    const x = (canvas.width - w) / 2;
    const y = (canvas.height - h) / 2;

    ctx.drawImage(video, x, y, w, h, 0, 0, canvas.width, canvas.height);

    // 撮影結果を別ウィンドウに表示
    const imgUrl = canvas.toDataURL("image/jpeg");
    window.open(imgUrl);
}

startCamera();
</script>
</body>
</html>
